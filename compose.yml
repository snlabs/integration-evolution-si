services:
  # Service MySQL
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: api
      MYSQL_USER: devuser
      MYSQL_PASSWORD: devpass
    volumes:
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./shared/db_data:/var/lib/mysql
      #- ./mysql/my.cnf:/etc/mysql/conf.d/my.cnf
    networks:
      - symfony-network

  # Service pour la première application Symfony (app1)
  app1:
    image: sbzteam/php:8.3-alpine
    depends_on:
      - mysql
    environment:
      DATABASE_URL: mysql://devuser:devpass@mysql:3306/api
    volumes:
      - ./app1:/var/www
    networks:
      - symfony-network
    expose:
      - "9000"
  #  restart: unless-stopped

  # Service pour la deuxième application Symfony (app2)
  app2:
    image: sbzteam/php:8.3-alpine
    depends_on:
      - mysql
      - rabbitmq
    environment:
      DATABASE_URL: mysql://devuser:devpass@mysql:3306/api
    volumes:
      - ./app2:/var/www
    networks:
      - symfony-network
    expose:
      - "9001"
   # restart: unless-stopped

  # Service Nginx pour la première application Symfony (app1)
  nginx-app1:
    image: nginx:latest
    container_name: nginx-app1
    volumes:
      - ./nginx/app1.conf:/etc/nginx/conf.d/default.conf
      - ./app1:/var/www
    ports:
      - "8001:80"
    networks:
      - symfony-network
    depends_on:
      - app1
    #restart: unless-stopped

  # Service Nginx pour la deuxième application Symfony (app2)
  nginx-app2:
    image: nginx:latest
    container_name: nginx-app2
    volumes:
      - ./nginx/app2.conf:/etc/nginx/conf.d/default.conf
      - ./app2:/var/www
    ports:
      - "8002:80"
    networks:
      - symfony-network
    depends_on:
      - app2
    #restart: unless-stopped

  rabbitmq:
      image: rabbitmq:3-management
      ports: [5672, 15672]
      environment:
        RABBITMQ_DEFAULT_USER: guest
        RABBITMQ_DEFAULT_PASS: guest
      networks:
        - symfony-network   
  
  phpmya:
    image: phpmyadmin/phpmyadmin:latest
    container_name: phpmyadmin
    environment:
      PMA_ARBITRARY: 1
      PMA_HOST: mysql
      PMA_USER: devuser
      PMA_PASSWORD: devpass
    depends_on:
      - mysql
    ports:
    - 8899:80 
    networks:
      - symfony-network  

networks:
  symfony-network:
    driver: bridge
